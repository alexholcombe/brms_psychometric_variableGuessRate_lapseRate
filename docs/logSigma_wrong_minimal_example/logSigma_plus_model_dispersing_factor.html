<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>logSigma estimation seems biased high</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="logSigma_plus_model_dispersing_factor_files/libs/clipboard/clipboard.min.js"></script>
<script src="logSigma_plus_model_dispersing_factor_files/libs/quarto-html/quarto.js"></script>
<script src="logSigma_plus_model_dispersing_factor_files/libs/quarto-html/popper.min.js"></script>
<script src="logSigma_plus_model_dispersing_factor_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="logSigma_plus_model_dispersing_factor_files/libs/quarto-html/anchor.min.js"></script>
<link href="logSigma_plus_model_dispersing_factor_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="logSigma_plus_model_dispersing_factor_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="logSigma_plus_model_dispersing_factor_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="logSigma_plus_model_dispersing_factor_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="logSigma_plus_model_dispersing_factor_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">logSigma estimation seems biased high</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Typically brms estimates logSigma as -1.41 instead of true value of -1.67.</p>
<p>Only doing single-level modeling here</p>
<p>To get started, we load the required packages.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here) <span class="co">#For finding root directory</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>( <span class="fu">here</span>(<span class="st">"R"</span>,<span class="st">"simulate_data_no_underscores.R"</span>) )  <span class="co">#Load my needed custom function</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>( <span class="fu">here</span>(<span class="st">"R"</span>,<span class="st">"psychometric_function.R"</span>) ) <span class="co">#Load my needed custom function</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">989</span>) <span class="co">#ensures reproducibility for testing</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>break_brms_by_making_numTargets_numeric<span class="ot">&lt;-</span> <span class="cn">FALSE</span> <span class="co">#Change factor to numeric, right before doing formula fit, so </span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>   <span class="co">#I know that it's brms that's the problem rather than the rest of my code</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="create-simulated-trials" class="level1">
<h1>Create simulated trials</h1>
<p>Set up simulated experiment design.</p>
<p>Maybe make sure the reference group (that the Intercept estimate pertains to) is the expected-worse group. This is in case I later set priors on the coefficients, so that I can set the priors to all be positive to be less confusing.</p>
<p>Supposedly the levels order determines what brms sets the reference group to.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>numTargetsConds<span class="ot">&lt;-</span> <span class="fu">factor</span>( <span class="fu">c</span>(<span class="st">"three"</span>, <span class="st">"two"</span>),</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">levels=</span><span class="fu">c</span>(<span class="st">"three"</span>, <span class="st">"two"</span>) ) <span class="co">#This defines factor order. Worst is first.</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>numSubjects<span class="ot">&lt;-</span> <span class="dv">25</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>trialsPerCondition<span class="ot">&lt;-</span> <span class="dv">30</span><span class="co">#20</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>laboratories<span class="ot">&lt;-</span> <span class="fu">factor</span>( <span class="fu">c</span>(<span class="st">"Holcombe"</span>, <span class="st">"Roudaia"</span>),</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">levels=</span><span class="fu">c</span>(<span class="st">"Holcombe"</span>, <span class="st">"Roudaia"</span>) ) <span class="co">#This defines the factor order</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">#Array of speeds (not very realistic because mostly controlled by a staircase in actual experiment)</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>speeds<span class="ot">&lt;-</span><span class="fu">seq</span>(.<span class="dv">02</span>,<span class="fl">1.8</span>, <span class="at">length.out =</span> <span class="dv">12</span>) <span class="co"># trials at 12 different speeds between .02 and 1.8</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In order to build and test our model in brms, we must first create a simulated data set that is similar to our actual experiment data. This allows us to confirm the brms model is working and successfully recovers the parameters we set before applying it to our real experimental data that has unknown parameter values. In the actual data, there will be many group-wise differences in location and scale parameters. The following simulated data only has explicit differences between the <span class="math inline">\(\eta\)</span> (location) of the two age groups (older vs younger).</p>
<p>Values per factor</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 2
  name            value
  &lt;chr&gt;           &lt;int&gt;
1 lab                 2
2 gender              2
3 ageGroup            2
4 subjWithinGroup    25
5 numTargets          2
6 obj_per_ring        4
7 speed              12
8 trialThisCond      30</code></pre>
</div>
</div>
<p>Create between-subject variability within each group, to create a potential multilevel modeling advantage. Can do this by passing the participant number to the location-parameter calculating function. Because that function will be called over and over, separately, the location parameter needs to be a deterministic function of the participant number. So it needs to calculate a hash or something to determine the location parameter. E.g. it could calculate the remainder, but then the location parameters wouldn’t be centered on the intended value for that condition. To do that, I think I need to know the number of participants in the condition, n, and number them 1..n. Then I can give e.g.&nbsp;participant 1 the extreme value on one side of the condition-determined value and give participant n the extreme value on the other side. So I number participants separately even within age*gender to maintain the age and gender penalties, but not within speed, of course. Also not within targetLoad or obj_per_ring.</p>
<p>Because the present purpose of numbering participants is to inject the right amount of between-participant variability, I will number the participants with a range of numbers that has unit standard deviation. Will call this column “subjStandardized”.</p>
<p>Choose values for psychometric function for younger and older</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>lapse <span class="ot">&lt;-</span> <span class="fl">0.05</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>sigma <span class="ot">&lt;-</span> <span class="fl">0.2</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>location_param_base<span class="ot">&lt;-</span><span class="fl">1.2</span> <span class="co">#location_param_young_123targets &lt;- c(1.7,1.0,0.8)</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>one_less_target_benefit<span class="ot">&lt;-</span><span class="fl">0.4</span> <span class="co">#0.3 #penalty for additional target</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>youth_benefit <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co">#0.4 #Old people have worse limit by this much</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>male_benefit <span class="ot">&lt;-</span><span class="dv">0</span> <span class="co">#0.15 #Female worse by this much</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>Roudaia_lab_benefit <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co">#0.2</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co">#Set parameters for differences between Ss in a group</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>eta_between_subject_sd <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co">#0.1 </span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co">#Using above parameters, need function to calculate a participant's location parameter</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co">#Include optional between_subject_variance</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>location_param_calculate<span class="ot">&lt;-</span> <span class="cf">function</span>(numTargets,ageGroup,gender,lab,</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>                                    subjStandardized,eta_between_subject_sd) {</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  base_location_param <span class="ot">&lt;-</span> location_param_base<span class="co"># location_param_young_123targets[targetLoad]</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">#calculate offset for this participant based on desired sigma_between_participant_variance</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  location_param <span class="ot">&lt;-</span> base_location_param <span class="sc">+</span> </span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>                    subjStandardized <span class="sc">*</span> eta_between_subject_sd</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  after_penalties <span class="ot">&lt;-</span>location_param <span class="sc">+</span> </span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">if_else</span>(lab<span class="sc">==</span><span class="st">"Roudaia"</span>,<span class="dv">1</span>,<span class="dv">0</span>) <span class="sc">*</span> Roudaia_lab_benefit <span class="sc">+</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">if_else</span>(ageGroup<span class="sc">==</span><span class="st">"younger"</span>,<span class="dv">1</span>,<span class="dv">0</span>) <span class="sc">*</span> youth_benefit <span class="sc">+</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">if_else</span>(numTargets<span class="sc">==</span><span class="st">"two"</span>,<span class="dv">1</span>,<span class="dv">0</span>) <span class="sc">*</span> one_less_target_benefit <span class="sc">+</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">if_else</span>(gender<span class="sc">==</span><span class="st">"M"</span>,<span class="dv">1</span>,<span class="dv">0</span>) <span class="sc">*</span> male_benefit</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> (after_penalties)</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="co">#Need version with fixed eta_between_subject_sd for use in mutate</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>location_param_calc_for_mutate<span class="ot">&lt;-</span> <span class="cf">function</span>(numTargets,ageGroup,gender,lab,</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>                                               subjStandardized) {</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">location_param_calculate</span>(numTargets,ageGroup,gender,lab,</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>                           subjStandardized, eta_between_subject_sd)</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Using the psychometric function, simulate whether participant is correct on each trial or not, and add that to the simulated data.</p>
</section>
<section id="plot-data" class="level1">
<h1>Plot data</h1>
<p>upper_bound = 1 - L*(1-C)</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="logSigma_plus_model_dispersing_factor_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="setting-up-our-model-in-brms" class="level1">
<h1>Setting up our Model in brms</h1>
<p>Setting a model formula in brms allows the use of multilevel models, where there is a hierarchical structure in the data. But at this point we haven’t made the model multi-level as we have been concentrating on the basics of brms.</p>
<p>The bf() function of brms allows the specification of a formula. The parameter can be defined by population effects, where the parameter’s effect is fixed, or group level effects where the parameter varies with a variable such as age. The “family” argument is a description of the response distribution and link function that the model uses. For more detailed information on setting up a formula and the different arguments in BRMS see<a href="https://paulbuerkner.com/brms/reference/brmsformula.html" class="uri">https://paulbuerkner.com/brms/reference/brmsformula.html</a></p>
<p>The model we used is based off our psychometric function used to generate the data mentioned previously. The only explicitly-coded difference in our simulated data is in the location parameter of older vs younger. Thus, in addition to the psychometric function, we allowed <span class="math inline">\(\eta\)</span> and <span class="math inline">\(\log(\sigma)\)</span> to vary by age group in the model. Because the psychometric function doesn’t map onto a canonical link function, we use the non-linear estimation capability of brms rather than linear regression with a link function.</p>
<p><em>Alex’s note: Using the nonlinear option is also what allowed us to set a prior on the thresholds <span class="math inline">\(\eta\)</span>, because we could then parametrize the function in terms of the x-intercept, whereas with the link-function approach, we are stuck with the conventional parameterization of a line, which <a href="https://bsky.app/profile/did:plc:kynaetyuzsp46xejc6mzpjle/post/3lg5lpartzs2z">has a term for the y-intercept but not the x-intercept</a> </em></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>my_formula <span class="ot">&lt;-</span> brms<span class="sc">::</span><span class="fu">bf</span>( </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>   correct <span class="sc">~</span> chance_rate <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span>chance_rate <span class="sc">-</span> lapseRate<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>chance_rate)) <span class="sc">*</span> <span class="fu">Phi</span>(<span class="sc">-</span>(speed<span class="sc">-</span>eta)<span class="sc">/</span><span class="fu">exp</span>(logSigma))</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>my_formula <span class="ot">&lt;-</span> my_formula<span class="sc">$</span>formula</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">#If don't want to fit lapseRate, need to supply it</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">#data_simulated$lapseRate&lt;- lapse</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co">#If I don't want to fit eta, need to supply it</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co">#true_eta&lt;- location_param_base</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co">#data_simulated$eta&lt;- true_eta</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>my_brms_formula <span class="ot">&lt;-</span> brms<span class="sc">::</span><span class="fu">bf</span>(</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  correct <span class="sc">~</span> chance_rate <span class="sc">+</span> (<span class="dv">1</span><span class="sc">-</span>chance_rate <span class="sc">-</span> lapseRate <span class="sc">*</span> (<span class="dv">1</span><span class="sc">-</span>chance_rate))<span class="sc">*</span><span class="fu">Phi</span>(<span class="sc">-</span>(speed<span class="sc">-</span>eta)<span class="sc">/</span><span class="fu">exp</span>(logSigma)), </span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  eta <span class="sc">~</span> numTargets, <span class="co">#lab + ageGroup + gender,</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  lapseRate <span class="sc">~</span> <span class="dv">1</span>, <span class="co">#~1 estimates intercept only</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  logSigma <span class="sc">~</span> <span class="dv">1</span>,<span class="co">#ageGroup,</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">bernoulli</span>(<span class="at">link=</span><span class="st">"identity"</span>), <span class="co">#Otherwise the default link 'logit' would be applied</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">nl =</span> <span class="cn">TRUE</span> <span class="co">#non-linear model</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="set-priors" class="level1">
<h1>Set priors</h1>
<p>See <a href="visualize_and_select_priors.html">visualize_and_select_priors.html</a> for motivation.</p>
<p>Plot the priors</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="logSigma_plus_model_dispersing_factor_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="fitting-model-to-simulated-data" class="level1">
<h1>Fitting Model to Simulated Data</h1>
<p>Fitting the model gives an estimation of the average parameter value of the participants. The brm() function is used to fit the model based on the given formula, data and priors. Other arguments of brm can adjust the model fitting in various ways, for more information on each of the arguments see <a href="https://paulbuerkner.com/brms/reference/brm.html" class="uri">https://paulbuerkner.com/brms/reference/brm.html</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (break_brms_by_making_numTargets_numeric) {</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Make numeric version of numTargets</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  data_simulated <span class="ot">&lt;-</span> data_simulated <span class="sc">|&gt;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">targets =</span> <span class="fu">case_when</span>(</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>      numTargets <span class="sc">==</span> <span class="st">"two"</span> <span class="sc">~</span> <span class="dv">2</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>      numTargets <span class="sc">==</span> <span class="st">"three"</span> <span class="sc">~</span> <span class="dv">3</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="dv">0</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Delete old column</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  data_simulated<span class="sc">$</span>numTargets <span class="ot">&lt;-</span> <span class="cn">NULL</span> <span class="co">#delete column</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  data_simulated <span class="ot">&lt;-</span> data_simulated <span class="sc">%&gt;%</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">numTargets =</span> targets)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Show stan code . But I dont know how to interrogate it to see the factors."</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>// generated with brms 2.22.0
functions {
}
data {
  int&lt;lower=1&gt; N;  // total number of observations
  array[N] int Y;  // response variable
  int&lt;lower=1&gt; K_eta;  // number of population-level effects
  matrix[N, K_eta] X_eta;  // population-level design matrix
  int&lt;lower=1&gt; K_lapseRate;  // number of population-level effects
  matrix[N, K_lapseRate] X_lapseRate;  // population-level design matrix
  int&lt;lower=1&gt; K_logSigma;  // number of population-level effects
  matrix[N, K_logSigma] X_logSigma;  // population-level design matrix
  // covariates for non-linear functions
  vector[N] C_1;
  vector[N] C_2;
  int prior_only;  // should the likelihood be ignored?
}
transformed data {
}
parameters {
  vector[K_eta] b_eta;  // regression coefficients
  vector&lt;lower=0,upper=1&gt;[K_lapseRate] b_lapseRate;  // regression coefficients
  vector&lt;lower=-2,upper=1.6&gt;[K_logSigma] b_logSigma;  // regression coefficients
}
transformed parameters {
  real lprior = 0;  // prior contributions to the log posterior
  lprior += normal_lpdf(b_eta[1] | 1, 2);
  lprior += normal_lpdf(b_eta[2] | 0, 2);
  lprior += beta_lpdf(b_lapseRate | 2, 33.33);
  lprior += normal_lpdf(b_logSigma | -1.20397280432594, 1.5)
    - 1 * log_diff_exp(normal_lcdf(1.6 | -1.20397280432594, 1.5), normal_lcdf(-2 | -1.20397280432594, 1.5));
}
model {
  // likelihood including constants
  if (!prior_only) {
    // initialize linear predictor term
    vector[N] nlp_eta = rep_vector(0.0, N);
    // initialize linear predictor term
    vector[N] nlp_lapseRate = rep_vector(0.0, N);
    // initialize linear predictor term
    vector[N] nlp_logSigma = rep_vector(0.0, N);
    // initialize non-linear predictor term
    vector[N] mu;
    nlp_eta += X_eta * b_eta;
    nlp_lapseRate += X_lapseRate * b_lapseRate;
    nlp_logSigma += X_logSigma * b_logSigma;
    for (n in 1:N) {
      // compute non-linear predictor values
      mu[n] = (C_1[n] + (1 - C_1[n] - nlp_lapseRate[n] * (1 - C_1[n])) * Phi( - (C_2[n] - nlp_eta[n]) / exp(nlp_logSigma[n])));
    }
    target += bernoulli_lpmf(Y | mu);
  }
  // priors including constants
  target += lprior;
}
generated quantities {
}</code></pre>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>Compiling Stan program...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Trying to compile a simple C file</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Running /Library/Frameworks/R.framework/Resources/bin/R CMD SHLIB foo.c
using C compiler: ‘Apple clang version 16.0.0 (clang-1600.0.26.6)’
using SDK: ‘’
clang -arch arm64 -I"/Library/Frameworks/R.framework/Resources/include" -DNDEBUG   -I"/Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/library/Rcpp/include/"  -I"/Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/library/RcppEigen/include/"  -I"/Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/library/RcppEigen/include/unsupported"  -I"/Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/library/BH/include" -I"/Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/library/StanHeaders/include/src/"  -I"/Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/library/StanHeaders/include/"  -I"/Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/library/RcppParallel/include/"  -I"/Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/library/rstan/include" -DEIGEN_NO_DEBUG  -DBOOST_DISABLE_ASSERTS  -DBOOST_PENDING_INTEGER_LOG2_HPP  -DSTAN_THREADS  -DUSE_STANC3 -DSTRICT_R_HEADERS  -DBOOST_PHOENIX_NO_VARIADIC_EXPRESSION  -D_HAS_AUTO_PTR_ETC=0  -include '/Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/library/StanHeaders/include/stan/math/prim/fun/Eigen.hpp'  -D_REENTRANT -DRCPP_PARALLEL_USE_TBB=1   -I/opt/R/arm64/include    -fPIC  -falign-functions=64 -Wall -g -O2  -c foo.c -o foo.o
In file included from &lt;built-in&gt;:1:
In file included from /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/library/StanHeaders/include/stan/math/prim/fun/Eigen.hpp:22:
In file included from /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/library/RcppEigen/include/Eigen/Dense:1:
In file included from /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/library/RcppEigen/include/Eigen/Core:19:
/Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/library/RcppEigen/include/Eigen/src/Core/util/Macros.h:679:10: fatal error: 'cmath' file not found
  679 | #include &lt;cmath&gt;
      |          ^~~~~~~
1 error generated.
make: *** [foo.o] Error 1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Start sampling</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#bulk-ess</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Time taken (min) = 15.8on_model' NOW (CHAIN 1).
Chain 2: 
Chain 2: Gradient evaluation took 0.063014 seconds
Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 630.14 seconds.
Chain 2: Adjust your expectations accordingly!
Chain 2: 
Chain 2: 
Chain 1: 
Chain 1: Gradient evaluation took 0.065933 seconds
Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 659.33 seconds.
Chain 1: Adjust your expectations accordingly!
Chain 1: 
Chain 1: 
Chain 1: Iteration:   1 / 700 [  0%]  (Warmup)
Chain 2: Iteration:   1 / 700 [  0%]  (Warmup)
Chain 1: Iteration:  70 / 700 [ 10%]  (Warmup)
Chain 1: Iteration: 140 / 700 [ 20%]  (Warmup)
Chain 1: Iteration: 210 / 700 [ 30%]  (Warmup)
Chain 1: Iteration: 280 / 700 [ 40%]  (Warmup)
Chain 2: Iteration:  70 / 700 [ 10%]  (Warmup)
Chain 1: Iteration: 350 / 700 [ 50%]  (Warmup)
Chain 1: Iteration: 351 / 700 [ 50%]  (Sampling)
Chain 2: Iteration: 140 / 700 [ 20%]  (Warmup)
Chain 1: Iteration: 420 / 700 [ 60%]  (Sampling)
Chain 2: Iteration: 210 / 700 [ 30%]  (Warmup)
Chain 2: Iteration: 280 / 700 [ 40%]  (Warmup)
Chain 1: Iteration: 490 / 700 [ 70%]  (Sampling)
Chain 2: Iteration: 350 / 700 [ 50%]  (Warmup)
Chain 2: Iteration: 351 / 700 [ 50%]  (Sampling)
Chain 1: Iteration: 560 / 700 [ 80%]  (Sampling)
Chain 2: Iteration: 420 / 700 [ 60%]  (Sampling)
Chain 2: Iteration: 490 / 700 [ 70%]  (Sampling)
Chain 1: Iteration: 630 / 700 [ 90%]  (Sampling)
Chain 2: Iteration: 560 / 700 [ 80%]  (Sampling)
Chain 2: Iteration: 630 / 700 [ 90%]  (Sampling)
Chain 1: Iteration: 700 / 700 [100%]  (Sampling)
Chain 1: 
Chain 1:  Elapsed Time: 391.664 seconds (Warm-up)
Chain 1:                495.052 seconds (Sampling)
Chain 1:                886.716 seconds (Total)
Chain 1: 
Chain 2: Iteration: 700 / 700 [100%]  (Sampling)
Chain 2: 
Chain 2:  Elapsed Time: 682.14 seconds (Warm-up)
Chain 2:                240.152 seconds (Sampling)
Chain 2:                922.292 seconds (Total)
Chain 2: </code></pre>
</div>
</div>
<p>The logSigma estimate tends to have wide confidence intervals, and be biased less negative?</p>
<p>Check how close the fit estimates are to the true parameters.</p>
<p>First report on logSigma.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Success. Looks like I/brms calculated/estimated the reference group logSigma correctly."</code></pre>
</div>
</div>
<p>Now report on eta_Intercept (if estimated).</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Success. Looks like I/brms calculated/estimated the eta_Intercept correctly."</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tidy.brmsfit(fit): some parameter names contain underscores: term
naming may be unreliable!</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 8
  effect component group term              estimate std.error conf.low conf.high
  &lt;chr&gt;  &lt;chr&gt;     &lt;lgl&gt; &lt;chr&gt;                &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1 fixed  cond      NA    eta_(Intercept)     1.20    0.00176    1.20      1.20  
2 fixed  cond      NA    eta_numTargetstwo   0.398   0.00245    0.392     0.402 
3 fixed  cond      NA    lapseRate_(Inter…   0.0508  0.000608   0.0497    0.0521
4 fixed  cond      NA    logSigma_(Interc…  -1.62    0.00848   -1.63     -1.60  </code></pre>
</div>
</div>
<p>If estimating intercept, calculate the reference group location parameter.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Discrepancy between my calculation of eta_reference, 1.4 and what brms calculated, 1.2 of -0.2</code></pre>
</div>
</div>
<p>Check brms’ estimate of sigma.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Success. Looks like I/brms calculated/estimated the reference group logSigma correctly."</code></pre>
</div>
</div>
<section id="plot-the-predictions-of-the-brms-fit" class="level2">
<h2 class="anchored" data-anchor-id="plot-the-predictions-of-the-brms-fit">Plot the predictions of the brms fit</h2>
<p>For an example condition, model only one factor and only use data relevant to that</p>
<p>Set up all the conditions to calculate the prediction for.</p>
<p>Plot</p>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `lab`, `numTargets`, `ageGroup`, `gender`,
`subjWithinGroup`</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="logSigma_plus_model_dispersing_factor_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Look at what is happening during the chain, as explained on the <a href="https://discourse.mc-stan.org/t/init-not-using-my-initial-values-and-seems-to-be-defaulting-to-0/39548">Stan forum</a></p>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>Registered S3 method overwritten by 'GGally':
  method from   
  +.gg   ggplot2</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="logSigma_plus_model_dispersing_factor_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Plot sigma specifically.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="logSigma_plus_model_dispersing_factor_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="logSigma_plus_model_dispersing_factor_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Use brms’ built-in plot to show posterior and chains.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="logSigma_plus_model_dispersing_factor_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Brms’ conditional_effects method visualizes the model-implied regression curve:</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>